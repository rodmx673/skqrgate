<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor QR Gate - Director</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen">

    <header class="bg-indigo-900 text-white p-4 shadow-2xl flex justify-between items-center border-b-4 border-indigo-500">
        <div>
            <h1 class="text-xl font-black italic tracking-tighter uppercase">QR Gate Skool</h1>
            <p class="text-[10px] font-bold text-indigo-300">SISTEMA DE MONITOREO EN VIVO</p>
        </div>
        <div class="text-right">
            <p id="nombreUser" class="font-black text-sm uppercase text-white">Cargando...</p>
            <p id="escuelaID" class="text-[10px] font-mono text-indigo-200 uppercase">ID: ---</p>
        </div>
    </header>

    <main class="p-6 max-w-5xl mx-auto">
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                <p class="text-slate-400 text-[10px] font-black uppercase mb-1">Estatus del Servidor</p>
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 bg-emerald-500 rounded-full animate-pulse"></div>
                    <span class="font-bold text-slate-700 uppercase text-xs">Conectado (V12)</span>
                </div>
            </div>
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                <p class="text-slate-400 text-[10px] font-black uppercase mb-1">Próxima Actualización</p>
                <div id="countdown" class="text-2xl font-black text-indigo-600 font-mono text-center">10s</div>
            </div>
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                <p class="text-slate-400 text-[10px] font-black uppercase mb-1">Registros de Hoy</p>
                <div id="totalHoy" class="text-2xl font-black text-slate-800 text-center">...</div>
            </div>
        </div>

        <div class="bg-white rounded-[2.5rem] shadow-xl border border-slate-200 overflow-hidden">
            <div class="bg-slate-50 p-6 border-b border-slate-100">
                <h2 class="font-black text-slate-800 text-sm uppercase italic tracking-wider">Historial Reciente (Entradas y Salidas)</h2>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-100 text-slate-500 text-[10px] uppercase font-black">
                        <tr>
                            <th class="p-4">Alumno</th>
                            <th class="p-4">Hora</th>
                            <th class="p-4 text-center">Movimiento</th>
                        </tr>
                    </thead>
                    <tbody id="tablaLogs" class="divide-y divide-slate-100">
                        <tr><td colspan="3" class="p-20 text-center text-slate-400 italic font-bold uppercase text-xs">Esperando datos del servidor...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        const MI_LINK_SERVIDOR = "https://script.google.com/macros/s/AKfycbxW2eTmjTj3UtOXJph2qi_-fMwE-A-8AT1EMt7a9achh1o7heNjXn8ZDhAOCJtDLrkP/exec";
        let timer = 10;

        // 1. RECUPERAR SESIÓN (Obligatorio)
        const session = JSON.parse(localStorage.getItem('userSession'));
        
        if (!session) {
            // Si no hay sesión, mandarlo al login
            window.location.href = 'login.html';
        } else {
            document.getElementById('nombreUser').innerText = session.nombre || "Director";
            document.getElementById('escuelaID').innerText = "ID: " + (session.idEscuela || "ESC-001");
        }

        // 2. FUNCIÓN PARA CARGAR DATOS
        async function cargarDatos() {
            try {
                // Usamos el email guardado en la sesión
                const url = `${MI_LINK_SERVIDOR}?action=getDirectorInfo&email=${encodeURIComponent(session.email)}`;
                const res = await fetch(url);
                const data = await res.json();

                if (data.status === "success") {
                    document.getElementById('totalHoy').innerText = data.totalAsistencias;
                    
                    const tbody = document.getElementById('tablaLogs');
                    tbody.innerHTML = "";

                    if (data.ultimasAsistencias && data.ultimasAsistencias.length > 0) {
                        data.ultimasAsistencias.forEach(reg => {
                            const esEntrada = reg.tipo === "Entrada";
                            const colorClass = esEntrada ? "bg-emerald-100 text-emerald-700 border-emerald-200" : "bg-orange-100 text-orange-700 border-orange-200";
                            
                            tbody.innerHTML += `
                                <tr class="hover:bg-indigo-50/30 transition">
                                    <td class="p-4 font-bold text-slate-700 uppercase text-xs">${reg.nombre}</td>
                                    <td class="p-4 text-xs font-mono text-slate-500">${reg.hora}</td>
                                    <td class="p-4 text-center">
                                        <span class="px-3 py-1 rounded-full text-[9px] font-black uppercase border ${colorClass}">
                                            ${reg.tipo}
                                        </span>
                                    </td>
                                </tr>
                            `;
                        });
                    } else {
                        tbody.innerHTML = `<tr><td colspan="3" class="p-10 text-center text-slate-400 uppercase text-[10px] font-bold italic">No hay movimientos hoy</td></tr>`;
                    }
                }
            } catch (error) {
                console.error("Error cargando logs:", error);
            }
        }

        // 3. TIMER DE REFRESCO
        setInterval(() => {
            timer--;
            document.getElementById('countdown').innerText = timer + "s";
            if (timer <= 0) {
                timer = 10;
                cargarDatos();
            }
        }, 1000);

        // Carga inicial al abrir la página
        cargarDatos();
    </script>
</body>
</html>